<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sipp Sipp ‚Äì Br√§dspel med popup och historik</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #ff8a00, #e52e71);
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0;
    min-height: 100vh;
  }

  h1 { margin: 10px; text-align:center; font-size: 1.8rem; }

  .board {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    gap: 0.5vw;
    width: 95vw;
    max-width: 800px;
    aspect-ratio: 10 / 4;
    margin-bottom: 20px;
  }

  .cell {
    border: 2px solid black;
    border-radius: 10%;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    font-size: min(2.5vw, 0.9rem);
    box-shadow: 2px 2px 8px rgba(0,0,0,0.5);
  }

  .cell::before { content: ""; display: block; padding-top: 100%; }

  .player {
    width: 30%;
    height: 30%;
    border-radius: 40%;
    position: absolute;
    border: 1px solid rgb(0, 0, 0);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.2rem;
  }

  .bounce { animation: bounce 0.3s ease forwards; }
  @keyframes bounce {
    0% { transform: translateY(0); }
    50% { transform: translateY(-15%); }
    100% { transform: translateY(0); }
  }

  button {
    padding: 10px 16px;
    font-size: 1rem;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    background: white;
    color: #e52e71;
    font-weight: bold;
    transition:0.3s;
  }
  button:hover { background: #ff8a00; color: white; }
  button:disabled { opacity: 0.6; cursor: not-allowed; }

  #info { margin-top: 8px; font-size: 1rem; text-align: center; }
  .player-name { font-weight: bold; padding: 2px 6px; border-radius: 6px; color: rgb(0,0,0); display:inline-block; }
  .turn-box, .roll-box { margin: 5px 0; font-size:1rem; }

  .back-button {
    position: absolute; top: 10px; left: 10px;
    display: flex; align-items: center; justify-content: center;
    width: 40px; height: 40px; background: rgba(0,0,0,0.3); border-radius: 12px;
    transition: background 0.3s; text-decoration: none; z-index: 10;
  }
  .back-button:hover { background: rgba(0,0,0,0.6); }
  .back-button svg { width: 20px; height: 20px; }

  .popup-overlay {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.6);
    display: none; justify-content: center; align-items: center;
    z-index: 100;
  }

  .popup-content {
    background: #1e1e2f;
    color: #ff8a00;
    padding: 20px;
    border-radius: 20px;
    max-width: 300px;
    text-align: center;
    font-family: 'Comic Sans MS', cursive;
    font-size: 1.2rem;
    font-weight: bold;
    text-shadow: 1px 1px 3px black;
    animation: glow 1.5s infinite alternate;
  }

  @keyframes glow {
    from { box-shadow: 0 0 10px #ff8a00, 0 0 20px #e52e71; }
    to { box-shadow: 0 0 25px #ff8a00, 0 0 40px #e52e71; }
  }

  .popup-content button {
    margin-top: 12px;
    background: #ff8a00;
    color: rgb(0,0,0);
    border-radius: 12px;
    padding: 8px 18px;
    font-weight: bold;
    cursor: pointer;
    transition:0.3s;
  }
  .popup-content button:hover { background: #e52e71; }

  #musicControls {
    position: fixed;
    top: 10px;
    right: 10px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    align-items: flex-end;
    background: rgba(0,0,0,0.3);
    padding: 8px 10px;
    border-radius: 12px;
    z-index: 10;
  }
  #musicControls button { font-size:0.9rem; padding:6px 10px; }
  #musicControls input[type="range"] { cursor:pointer; width: 120px; }
  #musicControls span { font-size:0.8rem; white-space: nowrap; }

  #history {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 600px;
    background: rgba(0,0,0,0.5);
    padding: 8px;
    border-radius: 12px;
    max-height: 150px;
    overflow-y: auto;
    font-size: 0.9rem;
  }

  @media (max-width: 600px){
    .board { grid-template-columns: repeat(5, 1fr); aspect-ratio: 5 / 8; }
    #musicControls { width: 90%; top:auto; bottom: 10px; right:50%; transform: translateX(50%); flex-direction:row; flex-wrap:wrap; justify-content:center; }
    #musicControls input[type="range"] { width: 80px; }
  }
</style>
</head>
<body>

<a href="sippsipp-spelare.html" class="back-button">
  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</a>

<h1>Sipp Sipp ‚Äì Br√§dspel</h1>

<div id="musicControls">
  <button id="prevSong">F√∂reg√•ende</button>
  <button id="playPause">Spela/Pausa</button>
  <button id="nextSong">N√§sta</button>
  <input type="range" id="progress" min="0" max="100" value="0">
  <span id="timeDisplay">0:00 / 0:00</span>
  <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="0.5">
  <span id="currentSong">L√•t 1</span>
  <span style="font-size:0.7rem;">By Sergio.M</span>
</div>

<audio id="bgMusic" loop></audio>

<div class="board" id="board"></div>
<button id="rollBtn">Kasta t√§rning</button>
<div id="info"></div>
<div id="history"></div>

<div class="popup-overlay" id="popup">
  <div class="popup-content" id="popupContent">
    <div id="popupText"></div>
    <button id="closePopup">St√§ng</button>
  </div>
</div>

<script>
const colors = ["#ff9999","#ffcc99","#ffff99","#ccff99","#99ff99","#99ffcc","#99ffff","#99ccff","#9999ff","#cc99ff"];
const rows = 4, cols = 10, board = document.getElementById("board");
const cells = [];
for(let r=0;r<rows;r++){
  for(let c=0;c<cols;c++){
    const cell = document.createElement("div");
    cell.classList.add("cell");
    const index = r*cols + c;
    let available = [...colors];
    if(c>0){ let leftColor=cells[index-1].style.backgroundColor; available=available.filter(col=>col!==leftColor);}
    if(r>0){ let topColor=cells[index-cols].style.backgroundColor; available=available.filter(col=>col!==topColor);}
    if(r<rows-1 && cells[(r+1)*cols+c]){ let bottomColor=cells[(r+1)*cols+c].style.backgroundColor; available=available.filter(col=>col!==bottomColor);}
    const chosen = available[Math.floor(Math.random()*available.length)];
    cell.style.backgroundColor = chosen;
    board.appendChild(cell);
    cells.push(cell);
  }
}

cells[0].style.backgroundColor = "#00ff00";
cells[cells.length-1].style.backgroundColor = "#ffb700";
cells[0].textContent = "START";
cells[cells.length-1].textContent = "M√ÖL";

const storedPlayers = JSON.parse(localStorage.getItem("sippPlayers")) || [];
const playerEmojis = ["üòÄ","üòé","üê±","üê∂","ü¶Ñ","üêº","üêµ","üê∏","üí©"];
const players = storedPlayers.map((p,i)=>{
  const player = { name:p.name, emoji:playerEmojis[i%playerEmojis.length], color:p.color||"#ffffff", pos:1 };
  const div=document.createElement("div");
  div.classList.add("player");
  div.textContent = player.emoji;
  div.style.background = player.color;
  cells[player.pos-1].appendChild(div);
  player.element = div;
  return player;
});

let turn=0, gameOver=false;
const info=document.getElementById("info");
const rollBtn=document.getElementById("rollBtn");
const popup=document.getElementById("popup");
const popupText=document.getElementById("popupText");
const closePopup=document.getElementById("closePopup");
const historyBox = document.getElementById("history");

const challengeTexts = {
  2:"Drick 1 klunk.",3:"Alla dricker 2 klunkar.",4:"V√§lj en spelare som dricker 3 klunkar.",5:"Utmaning! 'Jag har aldrig.. alla som gjort det dricker 1 klunk.",
  6:"Thunder! Spela en runda, f√∂rlorare dricker 2 klunkar.",7:"Drick 2 klunkar.",8:"V√§lj en spelare som dricker 4 klunk.",9:"Alla dricker 5 klunk.",
  10:"Utmaning! Drick 3 klunkar eller sjung en bit p√• en l√•t.",11:"Dela ut 2 klunkar till valfri spelare.",12:"Sanning eller konsekvens! Misslyckas? Drick 2 klunkar.",
  13:"Drick 3 klunk.",14:"V√§lj 2 spelare som dricker 1 klunk vardera.",15:"Utmaning! H√•ll en mini-t√§vling, f√∂rloraren dricker 1 shot.",
  16:"Utmaning! V√§lj en spelare att k√∂ra sten saxp√•se med, f√∂rloraren dricker 3 klunkar.",17:"V√§lj en spelare som dricker 2 klunkar.",18:"Vattenfall! Alla b√∂rjar dricka, du kan sluta n√§r personen till h√∂ger om dig slutar.",
  19:"Utmaning! 'Jag har aldrig.. alla som gjort det dricker 1 klunk.",20:"Alla dricker 1 klunk.",21:"V√§lj en spelare som dricker 3 klunkar.",22:"Higher or Lower! Misslyckas? Drick 1 shot.",
  23:"Drick 2 klunkar.",24:"Dela ut 1 klunk till valfri spelare.",25:"Utmaning! G√∂r en kort charad, vinnaren delar ut 1 shot.",26:"Alla dricker 2 klunkar.",
  27:"V√§lj en spelare som dricker 6 klunkar.",28:"Utmaning! V√§lj en spelare att t√§vla med, f√∂rloraren dricker 3 klunkar.",29:"Utmaning! 'Jag har aldrig.. alla som gjort det dricker 1 klunk.",
  30:"Alla dricker 2 klunkar.",31:"V√§lj en spelare som dricker 2 klunkar.",32:"Kategori! Misslyckas? Drick 3 klunk",33:"Drick 1 klunk.",
  34:"Dela ut 10 klunkar till valfria spelare.",35:"Utmaning! H√•ll en mini-t√§vling, f√∂rloraren dricker 3 klunkar.",36:"Alla dricker 1 klunk.",37:"V√§lj en spelare som dricker 1 klunk.",
  38:"Drick 2 klunkar.",39:"Utmaning! V√§lj en spelare att t√§vla med, f√∂rloraren dricker 5 klunk.",40:"GRATTIS! Du har n√•tt slutet och vunnit spelet!"
};

function renderPlayers(){
  cells.forEach((c,i)=>{
    c.textContent = (i===0)?"START":(i===cells.length-1?"M√ÖL":"");
    const cellPlayers = players.filter(p=>p.pos===i+1);
    cellPlayers.forEach((p,index)=>{
      const token=p.element;
      token.style.left=(index%3)*30+"%";
      token.style.top=Math.floor(index/3)*30+"%";
      c.appendChild(token);
    });
  });
}

function updateInfo(rolled=null){
  const current = players[turn];
  const next = players[(turn+1)%players.length];
  let html="";
  if(rolled===null){
    html=`<div class="turn-box"><span class="player-name" style="background:${current.color}">${current.emoji} ${current.name}</span> √§r p√• tur</div>`;
  } else {
    html=`<div class="roll-box"><span class="player-name" style="background:${current.color}">${current.emoji} ${current.name}</span> kastade ${rolled}!</div>`;
    html+=`<div class="turn-box">N√§sta tur: <span class="player-name" style="background:${next.color}">${next.emoji} ${next.name}</span></div>`;
  }
  info.innerHTML=html;
}

function addHistory(text){
  const div = document.createElement("div");
  div.textContent = text;
  historyBox.appendChild(div);
  historyBox.scrollTop = historyBox.scrollHeight;
}

function closePopupFunc(){
  popup.style.display="none";
  if(gameOver){
    window.location.href="sippsipp-spelare.html";
  } else {
    turn=(turn+1)%players.length;
    updateInfo();
    rollBtn.disabled=false;
  }
}
closePopup.addEventListener("click",closePopupFunc);

function rollDice(){
  if(popup.style.display==="flex"||gameOver) return;
  rollBtn.disabled=true;
  const currentPlayer=players[turn];
  const roll=Math.floor(Math.random()*6)+1;
  addHistory(`${currentPlayer.name} kastade ${roll}`);
  const targetPos=Math.min(currentPlayer.pos+roll,40);
  let steps=targetPos-currentPlayer.pos;

  function moveStep(){
    if(steps===0){
      renderPlayers();
      updateInfo(roll);
      if(currentPlayer.pos===40){
        gameOver=true;
        popupText.textContent=`üéâ ${currentPlayer.emoji} ${currentPlayer.name} har n√•tt slutet och vunnit spelet! üçª`;
        popup.style.display="flex";
        addHistory(`${currentPlayer.name} har vunnit spelet!`);
        return;
      }
      if(challengeTexts[currentPlayer.pos]){
        popupText.textContent=`${currentPlayer.emoji} ${currentPlayer.name}: ${challengeTexts[currentPlayer.pos]}`;
        popup.style.display="flex";
        addHistory(`${currentPlayer.name}: ${challengeTexts[currentPlayer.pos]}`);
        return;
      }
      turn=(turn+1)%players.length;
      rollBtn.disabled=false;
      updateInfo();
      return;
    }
    currentPlayer.pos++;
    const token=currentPlayer.element;
    token.classList.add("bounce");
    renderPlayers();
    setTimeout(()=>{ token.classList.remove("bounce"); },300);
    steps--;
    setTimeout(moveStep,300);
  }
  moveStep();
}

rollBtn.addEventListener("click",rollDice);
document.addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    if(popup.style.display==="flex") closePopupFunc();
    else rollDice();
  }
});

renderPlayers();
updateInfo();

// --- Musik ---
const songs = ["Ny mapp/Sipp Sipp.mp3",
"Ny mapp/Beer Pong.mp3",
"Ny mapp/Flip Cup.mp3",
"Ny mapp/Jag har aldrig.mp3",
"Ny mapp/Rygg mot Rygg.mp3",
"Ny mapp/Vattenfall!.mp3"
];
let currentIndex = 0;
const bgMusic = document.getElementById("bgMusic");
const playPauseBtn = document.getElementById("playPause");
const nextBtn = document.getElementById("nextSong");
const prevBtn = document.getElementById("prevSong");
const currentSongSpan = document.getElementById("currentSong");
const volumeControl = document.getElementById("volumeControl");
const progress = document.getElementById("progress");
const timeDisplay = document.getElementById("timeDisplay");

function playSong(index){
  bgMusic.src = songs[index];
  bgMusic.play();
  currentSongSpan.textContent = `L√•t ${index+1}`;
  currentIndex = index;
}

playSong(currentIndex);

playPauseBtn.addEventListener("click",()=>{ bgMusic.paused ? bgMusic.play() : bgMusic.pause(); });
nextBtn.addEventListener("click",()=>{ playSong((currentIndex+1)%songs.length); });
prevBtn.addEventListener("click",()=>{ playSong((currentIndex-1+songs.length)%songs.length); });
volumeControl.addEventListener("input",()=>{ bgMusic.volume = volumeControl.value; });

bgMusic.addEventListener("timeupdate",()=>{
  const percent = (bgMusic.currentTime / bgMusic.duration) * 100;
  progress.value = percent || 0;
  const currentM = Math.floor(bgMusic.currentTime/60);
  const currentS = Math.floor(bgMusic.currentTime%60).toString().padStart(2,'0');
  const durationM = Math.floor(bgMusic.duration/60);
  const durationS = Math.floor(bgMusic.duration%60).toString().padStart(2,'0');
  timeDisplay.textContent = `${currentM}:${currentS} / ${durationM}:${durationS}`;
});

progress.addEventListener("input",()=>{ if(bgMusic.duration) bgMusic.currentTime = (progress.value/100)*bgMusic.duration; });
bgMusic.addEventListener("ended",()=>{ playSong((currentIndex+1)%songs.length); });

</script>
</body>
</html>
